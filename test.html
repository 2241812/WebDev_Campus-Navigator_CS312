<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive School Navigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .node { transition: all 0.2s ease; cursor: pointer; }
        .node:hover, .node.draggable:hover { stroke: #38b2ac; stroke-width: 4; }
        .node.draggable { cursor: move; }
        .room { fill: #4a5568; stroke: #e2e8f0; }
        .hallway { fill: #a0aec0; stroke: #718096; }
        .stairs { fill: #63b3ed; stroke: #e2e8f0; }
        .elevator { fill: #f6ad55; stroke: #e2e8f0; }
        .elevator-employee { fill: #dd6b20; stroke: #e2e8f0; }
        .path {
            stroke-width: 5px;
            stroke: #68d391;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            animation: dash 2.5s linear forwards; /* Slower animation */
        }
        .highlight { fill: #68d391; stroke: #f0fff4; stroke-width: 2; }
        .selected-for-action { stroke: #f6ad55; stroke-width: 4; stroke-dasharray: 5,5; animation: pulsing-stroke 2s infinite linear; }
        #currentLocationMarker {
            fill: rgba(254, 252, 191, 0.5); /* yellow-100 with opacity */
            stroke: none;
            animation: floating-pulse 2.5s infinite ease-in-out;
            pointer-events: none;
        }
        @keyframes dash {
            from { stroke-dasharray: 1000; stroke-dashoffset: 1000; }
            to { stroke-dasharray: 1000; stroke-dashoffset: 0; }
        }
        /* More subtle pulsing animation */
        @keyframes floating-pulse {
            0% { transform: scale(1.3); opacity: 0.6; }
            50% { transform: scale(1.6); opacity: 0.3; }
            100% { transform: scale(1.3); opacity: 0.6; }
        }
        @keyframes pulsing-stroke {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: -20; }
        }
        .admin-add-btn.active {
            background-color: #38b2ac; /* teal-500 */
            color: white;
            box-shadow: 0 0 0 2px #4a5568;
        }
        #importMapInput { display: none; }
        #pathInstructions li { cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        #pathInstructions li:hover { background-color: #374151; } /* gray-700 */
        #pathInstructions li.active-step { background-color: #4f46e5; } /* indigo-600 */
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center p-4 min-h-screen">

    <!-- Main Content Wrapper -->
    <div class="w-full max-w-5xl flex flex-col">

        <!-- Map Area -->
        <div class="w-full h-[65vh] bg-gray-800 rounded-t-lg shadow-inner border-x border-t border-gray-700 relative">
            <div id="floorSelector" class="flex space-x-2 absolute top-4 left-1/2 -translate-x-1/2 z-10"></div>
            <div id="mapContainer" class="w-full h-full">
                <svg id="mapSvg" width="100%" height="100%" viewBox="0 0 800 500"></svg>
            </div>
            <div id="mapLegend" class="absolute bottom-2 left-2 bg-gray-900 bg-opacity-70 p-2 rounded-md text-xs text-gray-300 space-y-1">
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-gray-700 mr-2 border border-gray-400"></span>Room</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full" style="background-color: #63b3ed;"></span>Stairs</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full" style="background-color: #f6ad55;"></span>Public Elevator</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full" style="background-color: #dd6b20;"></span>Employee Elevator</div>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="w-full bg-gray-800 p-6 shadow-lg rounded-b-lg border-x border-b border-gray-700">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8">
                <!-- Pathfinding -->
                <div class="space-y-4">
                    <h2 class="text-xl font-bold text-white mb-2">Navigation</h2>
                    <div>
                        <label for="userRole" class="block text-sm font-medium text-gray-300 mb-1">Your Role</label>
                        <select id="userRole" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="user">Student</option>
                            <option value="pwd-student">PWD Student</option>
                            <option value="employee">Employee</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div>
                        <label for="startNode" class="block text-sm font-medium text-gray-300 mb-1">Start Location</label>
                        <select id="startNode" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="endNode" class="block text-sm font-medium text-gray-300 mb-1">End Location</label>
                        <select id="endNode" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <button id="findPathBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                        Find Path
                    </button>
                </div>
                
                <!-- Route Instructions -->
                <div id="pathResult">
                    <h2 class="text-xl font-bold text-white mb-2">Route</h2>
                    <div id="pathInstructions" class="text-gray-300 space-y-1 h-48 overflow-y-auto pr-2 bg-gray-900/50 p-2 rounded-md">
                        <p class="text-gray-500">Select a start and end point to see the route.</p>
                    </div>
                </div>
            
                <!-- Admin Panel -->
                <div id="adminPanel" class="hidden">
                     <h2 class="text-xl font-bold text-white mb-2">Admin Controls</h2>
                     <div id="adminStatus" class="bg-gray-700 p-2 rounded-md mb-3 text-center text-gray-300 text-sm">
                        Drag nodes to move them or select an action.
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-2 text-sm">
                        <button class="admin-add-btn bg-gray-600 hover:bg-gray-500 p-2 rounded-md" data-mode="add" data-type="room">Add Room</button>
                        <button class="admin-add-btn bg-gray-600 hover:bg-gray-500 p-2 rounded-md" data-mode="add" data-type="hallway">Add Hall</button>
                        <button class="admin-add-btn bg-blue-600 hover:bg-blue-500 p-2 rounded-md" data-mode="add" data-type="stairs">Add Stairs</button>
                        <button class="admin-add-btn bg-orange-500 hover:bg-orange-400 p-2 rounded-md" data-mode="add" data-type="elevator" data-access="all">Add Public Elev</button>
                        <button class="admin-add-btn bg-orange-800 hover:bg-orange-700 p-2 rounded-md" data-mode="add" data-type="elevator" data-access="employee">Add Emp Elev</button>
                        <button class="admin-add-btn bg-green-600 hover:bg-green-500 p-2 rounded-md" data-mode="connect">Connect</button>
                        <button class="admin-add-btn bg-yellow-600 hover:bg-yellow-500 p-2 rounded-md" data-mode="disconnect">Disconnect</button>
                        <button class="admin-add-btn bg-purple-600 hover:bg-purple-500 p-2 rounded-md" data-mode="rename">Rename</button>
                        <button class="admin-add-btn bg-red-700 hover:bg-red-600 p-2 rounded-md" data-mode="delete-node">Delete Node</button>
                        <button id="addFloorBtn" class="bg-teal-600 hover:bg-teal-700 p-2 rounded-md">Add Floor</button>
                        <button id="deleteFloorBtn" class="bg-red-800 hover:bg-red-700 p-2 rounded-md">Delete Floor</button>
                        <button id="exportMapBtn" class="bg-green-700 hover:bg-green-800 p-2 rounded-md">Export</button>
                        <label for="importMapInput" class="text-center bg-gray-600 hover:bg-gray-500 p-2 rounded-md cursor-pointer">Import</label>
                        <input type="file" id="importMapInput" accept=".json,application/json">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Universal Modal -->
    <div id="universalModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 shadow-xl w-full max-w-sm">
            <h3 id="modalTitle" class="text-lg font-bold text-white">Confirm Action</h3>
            <p id="modalMessage" class="text-gray-300 mt-2">Are you sure?</p>
            <input type="text" id="modalInput" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 mt-4 hidden" placeholder="Enter new name...">
            <div class="mt-6 flex justify-end space-x-4">
                <button id="modalCancelBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancel</button>
                <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-md">Confirm</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            let mapData = {
                "nodes": [
                    { "id": "D-101", "name": "Room 101", "type": "room", "floor": 1, "x": 100, "y": 100 }, { "id": "D-105", "name": "Room 105", "type": "room", "floor": 1, "x": 100, "y": 400 }, { "id": "D-115", "name": "Room 115", "type": "room", "floor": 1, "x": 700, "y": 250 }, { "id": "H-1-1", "name": "Hallway", "type": "hallway", "floor": 1, "x": 200, "y": 100 }, { "id": "H-1-2", "name": "Hallway", "type": "hallway", "floor": 1, "x": 200, "y": 400 }, { "id": "H-1-3", "name": "Hallway", "type": "hallway", "floor": 1, "x": 450, "y": 100 }, { "id": "H-1-4", "name": "Hallway", "type": "hallway", "floor": 1, "x": 450, "y": 400 }, { "id": "H-1-5", "name": "Hallway", "type": "hallway", "floor": 1, "x": 600, "y": 250 }, { "id": "S-1-W2", "name": "Stairs", "type": "stairs", "floor": 1, "x": 450, "y": 50 }, { "id": "E-1-C", "name": "Elevator (Emp)", "type": "elevator", "floor": 1, "x": 450, "y": 450, "access": "employee" }, { "id": "E-1-Pub", "name": "Elevator", "type": "elevator", "floor": 1, "x": 200, "y": 250, "access": "all" },
                    { "id": "D-210", "name": "Room 210", "type": "room", "floor": 2, "x": 700, "y": 100 }, { "id": "D-220", "name": "Room 220", "type": "room", "floor": 2, "x": 700, "y": 400 }, { "id": "H-2-1", "name": "Hallway", "type": "hallway", "floor": 2, "x": 200, "y": 100 }, { "id": "H-2-2", "name": "Hallway", "type": "hallway", "floor": 2, "x": 200, "y": 400 }, { "id": "H-2-3", "name": "Hallway", "type": "hallway", "floor": 2, "x": 450, "y": 100 }, { "id": "H-2-4", "name": "Hallway", "type": "hallway", "floor": 2, "x": 450, "y": 400 }, { "id": "H-2-5", "name": "Hallway", "type": "hallway", "floor": 2, "x": 600, "y": 100 }, { "id": "H-2-6", "name": "Hallway", "type": "hallway", "floor": 2, "x": 600, "y": 400 }, { "id": "S-2-W2", "name": "Stairs", "type": "stairs", "floor": 2, "x": 450, "y": 50 }, { "id": "E-2-C", "name": "Elevator (Emp)", "type": "elevator", "floor": 2, "x": 450, "y": 450, "access": "employee" }, { "id": "E-2-Pub", "name": "Elevator", "type": "elevator", "floor": 2, "x": 200, "y": 250, "access": "all" },
                    { "id": "D-301", "name": "Library", "type": "room", "floor": 3, "x": 150, "y": 250 }, { "id": "D-302", "name": "Computer Lab", "type": "room", "floor": 3, "x": 650, "y": 250 }, { "id": "H-3-1", "name": "Hallway", "type": "hallway", "floor": 3, "x": 300, "y": 250 }, { "id": "H-3-2", "name": "Hallway", "type": "hallway", "floor": 3, "x": 500, "y": 250 }, { "id": "H-3-3", "name": "Hallway", "type": "hallway", "floor": 3, "x": 400, "y": 100 }, { "id": "H-3-4", "name": "Hallway", "type": "hallway", "floor": 3, "x": 400, "y": 400 }, { "id": "S-3-W2", "name": "Stairs", "type": "stairs", "floor": 3, "x": 400, "y": 50 }, { "id": "E-3-C", "name": "Elevator (Emp)", "type": "elevator", "floor": 3, "x": 400, "y": 450, "access": "employee" }, { "id": "E-3-Pub", "name": "Elevator", "type": "elevator", "floor": 3, "x": 200, "y": 250, "access": "all" }
                ],
                "edges": [
                    { "source": "D-101", "target": "H-1-1" }, { "source": "D-105", "target": "H-1-2" }, { "source": "D-115", "target": "H-1-5" }, { "source": "H-1-1", "target": "H-1-2" }, { "source": "H-1-1", "target": "H-1-3" }, { "source": "H-1-2", "target": "H-1-4" }, { "source": "H-1-3", "target": "H-1-5" }, { "source": "H-1-4", "target": "H-1-5" }, { "source": "S-1-W2", "target": "H-1-3" }, { "source": "E-1-C", "target": "H-1-4" }, { "source": "H-1-1", "target": "E-1-Pub" }, { "source": "H-1-2", "target": "E-1-Pub" },
                    { "source": "D-210", "target": "H-2-5" }, { "source": "D-220", "target": "H-2-6" }, { "source": "H-2-1", "target": "H-2-2" }, { "source": "H-2-1", "target": "H-2-3" }, { "source": "H-2-2", "target": "H-2-4" }, { "source": "H-2-3", "target": "H-2-5" }, { "source": "H-2-4", "target": "H-2-6" }, { "source": "H-2-5", "target": "H-2-6" }, { "source": "S-2-W2", "target": "H-2-3" }, { "source": "E-2-C", "target": "H-2-4" }, { "source": "H-2-1", "target": "E-2-Pub" }, { "source": "H-2-2", "target": "E-2-Pub" },
                    { "source": "D-301", "target": "H-3-1" }, { "source": "D-302", "target": "H-3-2" }, { "source": "H-3-1", "target": "H-3-3" }, { "source": "H-3-1", "target": "H-3-4" }, { "source": "H-3-2", "target": "H-3-3" }, { "source": "H-3-2", "target": "H-3-4" }, { "source": "S-3-W2", "target": "H-3-3" }, { "source": "E-3-C", "target": "H-3-4" }, { "source": "E-3-Pub", "target": "H-3-1" },
                    { "source": "S-1-W2", "target": "S-2-W2" }, { "source": "E-1-C", "target": "E-2-C" }, { "source": "E-1-Pub", "target": "E-2-Pub" },
                    { "source": "S-2-W2", "target": "S-3-W2" }, { "source": "E-2-C", "target": "E-3-C" }, { "source": "E-2-Pub", "target": "E-3-Pub" }
                ],
                "floorPlans": {}
            };
            
            // --- STATE MANAGEMENT ---
            let currentFloor = 1; let isAdmin = false; let editMode = { mode: null, firstNodeId: null };
            let isDragging = false; let offset = { x: 0, y: 0 };
            let modalCallback = null;

            // --- DOM ELEMENTS ---
            const startNodeSelect = document.getElementById('startNode');
            const endNodeSelect = document.getElementById('endNode');
            const userRoleSelect = document.getElementById('userRole');
            const findPathBtn = document.getElementById('findPathBtn');
            const mapSvg = document.getElementById('mapSvg');
            const mapContainer = document.getElementById('mapContainer');
            const pathInstructions = document.getElementById('pathInstructions');
            const adminPanel = document.getElementById('adminPanel');
            const adminStatus = document.getElementById('adminStatus');
            const floorSelector = document.getElementById('floorSelector');
            const addFloorBtn = document.getElementById('addFloorBtn');
            const deleteFloorBtn = document.getElementById('deleteFloorBtn');
            const modal = document.getElementById('universalModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalInput = document.getElementById('modalInput');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const importMapInput = document.getElementById('importMapInput');
            const exportMapBtn = document.getElementById('exportMapBtn');

            // --- CORE LOGIC ---
            function getWeight(sourceNode, targetNode) {
                 if (sourceNode.floor !== targetNode.floor) {
                     if (sourceNode.type === 'stairs' && targetNode.type === 'stairs') return 15;
                     if (sourceNode.type === 'elevator' && targetNode.type === 'elevator') return 5;
                     return Infinity;
                 }
                 return Math.round(Math.hypot(sourceNode.x - targetNode.x, sourceNode.y - targetNode.y) / 10) || 1;
            }

            function findShortestPath(startId, endId, role) {
                const distances = {}; const previous = {}; const pq = new Map();
                mapData.nodes.forEach(node => { distances[node.id] = Infinity; previous[node.id] = null; pq.set(node.id, Infinity); });
                distances[startId] = 0; pq.set(startId, 0);
                
                const isNodeAccessible = (node) => {
                    if (!node) return false;
                    if (role === 'pwd-student' && node.type === 'stairs') return false;
                    if (role !== 'admin' && role !== 'employee' && node.access === 'employee') return false;
                    return true;
                };

                while (pq.size > 0) {
                    let closestNodeId = null; let minDistance = Infinity;
                    for (const [nodeId, dist] of pq.entries()) { if (dist < minDistance) { minDistance = dist; closestNodeId = nodeId; } }
                    if (closestNodeId === endId || closestNodeId === null || distances[closestNodeId] === Infinity) break;
                    
                    const closestNode = mapData.nodes.find(n => n.id === closestNodeId);
                    pq.delete(closestNodeId);

                    if (!isNodeAccessible(closestNode)) continue;
                    
                    const neighbors = mapData.edges.filter(edge => edge.source === closestNodeId || edge.target === closestNodeId);
                    for (const edge of neighbors) {
                        const neighborId = edge.source === closestNodeId ? edge.target : edge.source;
                        const neighborNode = mapData.nodes.find(n => n.id === neighborId);
                        if (!isNodeAccessible(neighborNode)) continue;
                        
                        const newDist = distances[closestNodeId] + getWeight(closestNode, neighborNode);
                        
                        if (newDist < distances[neighborId]) {
                            distances[neighborId] = newDist;
                            previous[neighborId] = closestNodeId;
                            if (pq.has(neighborId)) { pq.set(neighborId, newDist); }
                        }
                    }
                }
                const path = []; let currentNode = endId;
                while (currentNode) { path.unshift(currentNode); currentNode = previous[currentNode]; }
                return path[0] === startId ? path : null;
            }

            // --- UI & SVG RENDERING ---
            function updateFloorButtons() {
                floorSelector.innerHTML = '';
                const floors = [...new Set(mapData.nodes.map(n => n.floor))].sort((a,b) => a-b);
                floors.forEach(floorNum => {
                    const button = document.createElement('button');
                    button.textContent = `Floor ${floorNum}`;
                    button.className = `px-4 py-2 rounded-md text-sm font-medium transition ${currentFloor === floorNum ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}`;
                    button.onclick = () => switchFloor(floorNum);
                    floorSelector.appendChild(button);
                });
            }

            function switchFloor(floorNum) {
                if (!mapData.nodes.some(n => n.floor === floorNum)) {
                     const floors = [...new Set(mapData.nodes.map(n => n.floor))].sort((a,b) => a-b);
                     floorNum = floors.length > 0 ? floors[0] : 1;
                }
                currentFloor = floorNum;
                mapContainer.style.opacity = '0';
                setTimeout(() => {
                    drawCurrentFloor();
                    updateFloorButtons();
                    mapContainer.style.opacity = '1';
                }, 500); // Slower transition
            }
            
            function populateSelectors() {
                const startVal = startNodeSelect.value;
                const endVal = endNodeSelect.value;
                startNodeSelect.innerHTML = ''; endNodeSelect.innerHTML = '';
                const rooms = mapData.nodes.filter(node => node.type === 'room').sort((a, b) => a.id.localeCompare(b.id));
                rooms.forEach(room => {
                    const option1 = new Option(`${room.name} (F${room.floor})`, room.id);
                    const option2 = new Option(`${room.name} (F${room.floor})`, room.id);
                    startNodeSelect.add(option1); endNodeSelect.add(option2);
                });
                startNodeSelect.value = startVal;
                endNodeSelect.value = endVal;
                if (!endNodeSelect.value && endNodeSelect.options.length > 1) endNodeSelect.selectedIndex = 1;
                 if (startNodeSelect.options.length === 0) {
                    startNodeSelect.add(new Option('No rooms available', ''));
                    endNodeSelect.add(new Option('No rooms available', ''));
                }
            }

            function drawCurrentFloor() {
                mapSvg.innerHTML = '';
                 if (!mapData.nodes.some(n => n.floor === currentFloor)) {
                     mapSvg.innerHTML = '<text x="400" y="250" text-anchor="middle" fill="white" font-size="20">No floors exist. Add a floor.</text>';
                     return;
                 }

                if (mapData.floorPlans && mapData.floorPlans[currentFloor]) {
                    const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                    image.setAttribute('href', mapData.floorPlans[currentFloor]);
                    image.setAttribute('x', '0'); image.setAttribute('y', '0');
                    image.setAttribute('width', '800'); image.setAttribute('height', '500');
                    mapSvg.appendChild(image);
                }
                const nodesToDraw = mapData.nodes.filter(n => n.floor === currentFloor);
                const edgesToDraw = mapData.edges.filter(edge => {
                    const sourceNode = mapData.nodes.find(n => n.id === edge.source);
                    const targetNode = mapData.nodes.find(n => n.id === edge.target);
                    return sourceNode && targetNode && sourceNode.floor === currentFloor && targetNode.floor === currentFloor;
                });
                edgesToDraw.forEach(edge => {
                    const sourceNode = mapData.nodes.find(n => n.id === edge.source);
                    const targetNode = mapData.nodes.find(n => n.id === edge.target);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', sourceNode.x); line.setAttribute('y1', sourceNode.y);
                    line.setAttribute('x2', targetNode.x); line.setAttribute('y2', targetNode.y);
                    line.setAttribute('stroke', '#4A5568'); line.setAttribute('stroke-width', 2);
                    mapSvg.appendChild(line);
                });
                nodesToDraw.forEach(node => {
                    const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    group.setAttribute('id', `g-${node.id}`);
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('id', node.id); circle.setAttribute('cx', node.x); circle.setAttribute('cy', node.y);
                    circle.setAttribute('r', node.type === 'room' ? 15 : (node.type === 'hallway' ? 5 : 10));
                    
                    let nodeClass = `node ${node.type} ${isAdmin ? 'draggable' : ''}`;
                    if (node.type === 'elevator' && node.access === 'employee') nodeClass += ' elevator-employee';
                    if (editMode.firstNodeId === node.id) nodeClass += ' selected-for-action';
                    circle.setAttribute('class', nodeClass);
                    group.appendChild(circle);
                    if (node.type !== 'hallway') {
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', node.x); text.setAttribute('y', node.y + (node.type === 'room' ? 30 : 25));
                        text.setAttribute('text-anchor', 'middle'); text.setAttribute('fill', 'white');
                        text.setAttribute('font-size', '12'); text.style.pointerEvents = 'none';
                        text.textContent = node.name;
                        group.appendChild(text);
                    }
                    if(isAdmin) group.addEventListener('mousedown', (e) => { e.stopPropagation(); startDrag(e, node.id); });
                    mapSvg.appendChild(group);
                });
            }

            function handleFindPath() {
                clearHighlights();
                const startId = startNodeSelect.value; const endId = endNodeSelect.value; const role = userRoleSelect.value;
                if (!startId || !endId) { pathInstructions.innerHTML = '<p class="text-yellow-400">Please select start and end locations.</p>'; return; }
                if (startId === endId) { pathInstructions.innerHTML = '<p class="text-yellow-400">Start and end cannot be the same.</p>'; return; }
                const path = findShortestPath(startId, endId, role);
                if (path) { animatePath(path, 0); } 
                else { pathInstructions.innerHTML = '<p class="text-red-400">No path found. The route may be restricted.</p>'; }
            }
            
            function animatePath(path, pathIndex) {
                if (pathIndex === 0) { pathInstructions.innerHTML = '<ol id="instructionList" class="list-decimal list-inside"></ol>'; }
                if (pathIndex >= path.length) return;
                const startNode = mapData.nodes.find(n => n.id === path[pathIndex]);
                if (!startNode) return;
                switchFloor(startNode.floor);
                setTimeout(() => {
                    let segment = []; let nextFloor = -1;
                    for (let i = pathIndex; i < path.length; i++) {
                        const currentNode = mapData.nodes.find(n => n.id === path[i]);
                        if (currentNode.floor === startNode.floor) { segment.push(path[i]); } 
                        else { nextFloor = currentNode.floor; break; }
                    }
                    drawSegment(segment);
                    if (nextFloor !== -1) { animatePath(path, pathIndex + segment.length); }
                }, 800); // Slower animation
            }

            function drawSegment(segment) {
                if (segment.length === 0) return;
                const instructionList = document.getElementById('instructionList');
                if (segment.length > 1) {
                    const points = segment.map(nodeId => { const node = mapData.nodes.find(n => n.id === nodeId); return `${node.x},${node.y}`; }).join(' ');
                    const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                    polyline.setAttribute('points', points); polyline.setAttribute('class', 'path');
                    if(mapSvg.firstChild) mapSvg.insertBefore(polyline, mapSvg.firstChild.nextSibling); else mapSvg.appendChild(polyline);
                }
                segment.forEach(nodeId => { const nodeEl = document.getElementById(nodeId); if (nodeEl) nodeEl.classList.add('highlight'); });
                for(let i = 0; i < segment.length - 1; i++){
                    const stepFrom = mapData.nodes.find(n => n.id === segment[i]);
                    const stepTo = mapData.nodes.find(n => n.id === segment[i+1]);
                    if (stepFrom.type === 'hallway' && stepTo.type === 'hallway') continue;
                    const li = document.createElement('li');
                    li.innerHTML = `Go from <strong>${stepFrom.name}</strong> to <strong>${stepTo.name}</strong>`;
                    li.dataset.nodeId = stepFrom.id;
                    li.dataset.floor = stepFrom.floor;
                    instructionList.appendChild(li);
                }
            }
            
            function clearHighlights() {
                document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
                document.querySelectorAll('.path').forEach(el => el.remove());
                document.querySelectorAll('#currentLocationMarker').forEach(el => el.remove());
                pathInstructions.innerHTML = '<p class="text-gray-500">Select a start and end point to see the route.</p>';
            }

            function showCurrentLocation(nodeId, floor) {
                 if (currentFloor !== floor) {
                    switchFloor(floor);
                 }
                setTimeout(() => {
                    document.querySelectorAll('#currentLocationMarker').forEach(el => el.remove());
                    const node = mapData.nodes.find(n => n.id === nodeId);
                    if(node) {
                        const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        marker.id = 'currentLocationMarker';
                        marker.setAttribute('cx', node.x);
                        marker.setAttribute('cy', node.y);
                        marker.setAttribute('r', (node.type === 'room' ? 15 : (node.type === 'hallway' ? 5 : 10)) + 5);
                        mapSvg.appendChild(marker);
                    }
                }, 550); // wait for floor switch
            }

            // --- ADMIN FUNCTIONALITY ---
            function showModal(options) {
                const { title, message, showInput = false, placeholder = '', confirmText = 'Confirm', onConfirm } = options;
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalInput.classList.toggle('hidden', !showInput);
                modalInput.placeholder = placeholder;
                modalInput.value = placeholder;
                modalConfirmBtn.textContent = confirmText;
                modalCallback = onConfirm;
                modal.style.display = 'flex';
                if(showInput) modalInput.focus();
            }

            function hideModal() {
                modal.style.display = 'none';
                modalCallback = null;
            }

            function toggleAdminMode(isAdminEnabled) { isAdmin = isAdminEnabled; adminPanel.classList.toggle('hidden', !isAdmin); setEditMode({mode: null}); drawCurrentFloor(); }
            function getMousePosition(evt) { const CTM = mapSvg.getScreenCTM(); return { x: (evt.clientX - CTM.e) / CTM.a, y: (evt.clientY - CTM.f) / CTM.d }; }
            function startDrag(evt, nodeId) { if (!isAdmin || editMode.mode) return; isDragging = true; const pos = getMousePosition(evt); const node = mapData.nodes.find(n => n.id === nodeId); offset.x = pos.x - node.x; offset.y = pos.y - node.y; }
            function drag(evt) { if (isDragging) { evt.preventDefault(); const pos = getMousePosition(evt); const g = document.getElementById(`g-${evt.target.id}`); const node = mapData.nodes.find(n => n.id === evt.target.id); if(!g || !node) return; node.x = Math.round(pos.x - offset.x); node.y = Math.round(pos.y - offset.y); drawCurrentFloor(); } }
            function endDrag() { isDragging = false; }
            
            function handleMapClick(evt) {
                if (!isAdmin) return;
                const targetId = evt.target.id;
                const targetNode = mapData.nodes.find(n => n.id === targetId);

                switch (editMode.mode) {
                    case 'add':
                        const pos = getMousePosition(evt);
                        const capitalType = editMode.type.charAt(0).toUpperCase() + editMode.type.slice(1);
                        const newNode = { id: `${editMode.type.charAt(0).toUpperCase()}-${currentFloor}-${Date.now()}`, name: `New ${capitalType}`, type: editMode.type, floor: currentFloor, x: Math.round(pos.x), y: Math.round(pos.y), access: editMode.access || 'all' };
                        mapData.nodes.push(newNode);
                        const nodesOnFloor = mapData.nodes.filter(n => n.floor === currentFloor && n.id !== newNode.id);
                        if(nodesOnFloor.length > 0) {
                            let closestNode = null; let minDistance = Infinity;
                            nodesOnFloor.forEach(node => { const dist = Math.hypot(node.x - newNode.x, node.y - newNode.y); if (dist < minDistance) { minDistance = dist; closestNode = node; } });
                            mapData.edges.push({ source: newNode.id, target: closestNode.id });
                        }
                        if(newNode.type === 'room') populateSelectors();
                        drawCurrentFloor();
                        break;
                    case 'connect':
                        if (!targetNode) return;
                        if (!editMode.firstNodeId) {
                            editMode.firstNodeId = targetId;
                            adminStatus.textContent = `Selected ${targetNode.name}. Select second node.`;
                        } else {
                            if (editMode.firstNodeId === targetId) return;
                            const firstNode = mapData.nodes.find(n => n.id === editMode.firstNodeId);
                            if(firstNode.floor !== targetNode.floor) {
                                if (!((firstNode.type === 'stairs' && targetNode.type === 'stairs') || (firstNode.type === 'elevator' && targetNode.type === 'elevator'))) {
                                    adminStatus.textContent = "Error: Cross-floor links must be Stairs-to-Stairs or Elevator-to-Elevator.";
                                    setTimeout(() => setEditMode({mode: 'connect'}), 2000);
                                    return;
                                }
                            }
                            mapData.edges.push({ source: editMode.firstNodeId, target: targetId });
                            adminStatus.textContent = `Connected ${firstNode.name} and ${targetNode.name}!`;
                            setEditMode({mode: 'connect'});
                        }
                        drawCurrentFloor();
                        break;
                    case 'disconnect':
                         if (!targetNode) return;
                        if (!editMode.firstNodeId) {
                            editMode.firstNodeId = targetId;
                            adminStatus.textContent = `Selected ${targetNode.name}. Click second node.`;
                        } else {
                            if (editMode.firstNodeId === targetId) return;
                            const firstNodeName = mapData.nodes.find(n => n.id === editMode.firstNodeId).name;
                            const originalEdgeCount = mapData.edges.length;
                            mapData.edges = mapData.edges.filter(e => 
                                !((e.source === editMode.firstNodeId && e.target === targetId) || (e.source === targetId && e.target === editMode.firstNodeId))
                            );
                            if(mapData.edges.length < originalEdgeCount) adminStatus.textContent = `Disconnected ${firstNodeName} and ${targetNode.name}.`;
                            else adminStatus.textContent = `No direct connection found.`;
                            setEditMode({mode: 'disconnect'});
                        }
                        drawCurrentFloor();
                        break;
                    case 'rename':
                        if (!targetNode) return;
                        showModal({
                            title: `Rename ${targetNode.type}`,
                            message: `Enter new name for "${targetNode.name}":`,
                            showInput: true,
                            placeholder: targetNode.name,
                            confirmText: 'Save',
                            onConfirm: (newName) => {
                                if(newName && newName.trim() !== '') {
                                    targetNode.name = newName.trim();
                                    populateSelectors();
                                    drawCurrentFloor();
                                    hideModal();
                                    setEditMode({mode: 'rename'});
                                }
                            }
                        });
                        break;
                    case 'delete-node':
                        if (!targetNode) return;
                        showModal({
                            title: `Delete ${targetNode.name}?`,
                            message: 'This will permanently remove the node and its connections.',
                            confirmText: 'Delete',
                            onConfirm: () => {
                                mapData.nodes = mapData.nodes.filter(n => n.id !== targetId);
                                mapData.edges = mapData.edges.filter(e => e.source !== targetId && e.target !== targetId);
                                if (targetNode.type === 'room') populateSelectors();
                                drawCurrentFloor();
                                hideModal();
                                setEditMode({mode: 'delete-node'});
                            }
                        });
                        break;
                }
            }
             function handleDeleteFloor() {
                const floorCount = [...new Set(mapData.nodes.map(n => n.floor))].length;
                if (floorCount === 0) { adminStatus.textContent = "No floors to delete."; return; }
                if (floorCount <= 1 && mapData.nodes.length > 0) { adminStatus.textContent = "Cannot delete the last remaining floor."; return; }
                 showModal({
                     title: `Delete Floor ${currentFloor}?`,
                     message: "This will remove all nodes on this floor. This action cannot be undone.",
                     confirmText: 'Delete',
                     onConfirm: () => {
                        const nodesOnOtherFloors = mapData.nodes.filter(n => n.floor !== currentFloor);
                        const nodeIdsToKeep = new Set(nodesOnOtherFloors.map(n => n.id));
                        mapData.nodes = nodesOnOtherFloors;
                        mapData.edges = mapData.edges.filter(e => nodeIdsToKeep.has(e.source) && nodeIdsToKeep.has(e.target));
                        delete mapData.floorPlans[currentFloor];
                        
                        hideModal();
                        populateSelectors();
                        const remainingFloors = [...new Set(mapData.nodes.map(n => n.floor))];
                        const newFloor = remainingFloors.length > 0 ? Math.min(...remainingFloors) : 1;
                        switchFloor(newFloor);
                     }
                 });
            }
            function handleAddNewFloor() {
                const existingFloors = [...new Set(mapData.nodes.map(n => n.floor))];
                let newFloorNum = 1;
                if (existingFloors.length > 0) { newFloorNum = Math.max(...existingFloors) + 1; }
                const lastFloorNum = newFloorNum - 1;
                
                const lastFloorStairs = mapData.nodes.find(n => n.floor === lastFloorNum && n.type === 'stairs');
                const lastFloorEmpElevator = mapData.nodes.find(n => n.floor === lastFloorNum && n.type === 'elevator' && n.access === 'employee');
                const lastFloorPubElevator = mapData.nodes.find(n => n.floor === lastFloorNum && n.type === 'elevator' && n.access === 'all');
                
                if(lastFloorNum > 0) {
                    if (lastFloorStairs) {
                        const newId = `S-${newFloorNum}-W2`;
                        mapData.nodes.push({ id: newId, name: "Stairs", type: "stairs", floor: newFloorNum, x: lastFloorStairs.x, y: lastFloorStairs.y, access: 'all' });
                        mapData.edges.push({ source: lastFloorStairs.id, target: newId });
                    }
                    if (lastFloorEmpElevator) {
                        const newId = `E-${newFloorNum}-C`;
                        mapData.nodes.push({ id: newId, name: "Elevator (Emp)", type: "elevator", floor: newFloorNum, x: lastFloorEmpElevator.x, y: lastFloorEmpElevator.y, access: "employee" });
                        mapData.edges.push({ source: lastFloorEmpElevator.id, target: newId });
                    }
                    if (lastFloorPubElevator) {
                        const newId = `E-${newFloorNum}-Pub`;
                        mapData.nodes.push({ id: newId, name: "Elevator", type: "elevator", floor: newFloorNum, x: lastFloorPubElevator.x, y: lastFloorPubElevator.y, access: "all" });
                        mapData.edges.push({ source: lastFloorPubElevator.id, target: newId });
                    }
                } else {
                     mapData.nodes.push({ id: `H-${newFloorNum}-Start`, name: "Hallway", type: "hallway", floor: newFloorNum, x: 400, y: 250 });
                }
                adminStatus.textContent = `Floor ${newFloorNum} added successfully!`; 
                switchFloor(newFloorNum);
            }
             function setEditMode({ mode, type = null, access = 'all' }) {
                const wasActive = document.querySelector('.admin-add-btn.active');
                const clickedBtn = document.querySelector(`.admin-add-btn[data-mode="${mode}"]`);
                
                if (wasActive === clickedBtn && editMode.mode === mode) {
                    editMode = { mode: null, firstNodeId: null };
                    if(wasActive) wasActive.classList.remove('active');
                     adminStatus.textContent = 'Drag nodes to move them.';
                } else {
                    editMode = { mode, type, access, firstNodeId: null };
                    document.querySelectorAll('.admin-add-btn.active').forEach(b => b.classList.remove('active'));
                    if(clickedBtn) clickedBtn.classList.add('active');

                    const modeText = {
                        add: `Click map to add new ${type}.`,
                        connect: `Click first node to connect.`,
                        disconnect: `Click first node to disconnect.`,
                        rename: `Click a node to rename it.`,
                        'delete-node': `Click a node to delete it.`
                    };
                    adminStatus.textContent = modeText[mode] || 'Drag nodes to move them.';
                }
                 drawCurrentFloor();
            }
           
            function handleExportMapData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(mapData, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "school_map_data.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                adminStatus.textContent = "Map data exported successfully!";
            }
            function handleImportMapData(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData && importedData.nodes && importedData.edges) {
                            mapData = importedData;
                            adminStatus.textContent = "Map data imported successfully!";
                            populateSelectors();
                            const firstFloor = mapData.nodes.length > 0 ? Math.min(...mapData.nodes.map(n => n.floor)) : 1;
                            switchFloor(firstFloor);
                        } else { adminStatus.textContent = "Error: Invalid JSON file structure."; }
                    } catch (error) { adminStatus.textContent = "Error parsing JSON file."; }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            // --- INITIALIZATION ---
            populateSelectors(); updateFloorButtons(); switchFloor(1);
            userRoleSelect.addEventListener('change', (e) => toggleAdminMode(e.target.value === 'admin'));
            findPathBtn.addEventListener('click', handleFindPath);
            startNodeSelect.addEventListener('change', clearHighlights);
            endNodeSelect.addEventListener('change', clearHighlights);
            mapSvg.addEventListener('mousemove', drag); mapSvg.addEventListener('mouseup', endDrag);
            mapSvg.addEventListener('mouseleave', endDrag);
            mapSvg.addEventListener('click', handleMapClick);
            addFloorBtn.addEventListener('click', handleAddNewFloor);
            deleteFloorBtn.addEventListener('click', handleDeleteFloor);
            document.querySelectorAll('.admin-add-btn').forEach(btn => { 
                btn.addEventListener('click', () => setEditMode({ mode: btn.dataset.mode, type: btn.dataset.type, access: btn.dataset.access })); 
            });
            modalCancelBtn.addEventListener('click', hideModal);
            modalConfirmBtn.addEventListener('click', () => {
                if (modalCallback) modalCallback(modalInput.value);
            });
            exportMapBtn.addEventListener('click', handleExportMapData);
            importMapInput.addEventListener('change', handleImportMapData);
            pathInstructions.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (!li || !li.dataset.nodeId) return;
                document.querySelectorAll('#instructionList li.active-step').forEach(el => el.classList.remove('active-step'));
                li.classList.add('active-step');
                showCurrentLocation(li.dataset.nodeId, parseInt(li.dataset.floor));
            });
        });
    </script>
</body>
</html>

